name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: "3.12"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install system packages (build deps + OpenCV + pybind11)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            pkg-config \
            libopencv-dev \
            python3-dev \
            python3-numpy \
            pybind11-dev

      - name: Upgrade pip and install python packages (pybind11, numpy, others)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [ -f "requirements.txt" ]; then
            python -m pip install -r requirements.txt
          fi
          # Ensure pybind11 and numpy available for cmake/find_package
          python -m pip install pybind11 numpy

      - name: Create build dir
        working-directory: ./core
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -Dpybind11_DIR=/usr/share/cmake/pybind11

      - name: Build C++ extension
        working-directory: ./core/build
        run: |
          cmake --build . --config Release -- -j$(nproc)

      - name: Run Streamlit app briefly to check it starts
        env:
          PYTHONPATH: ./core/build:$PYTHONPATH
        run: |
          python -m pip install streamlit opencv-python-headless numpy
          # Run Streamlit in background
          streamlit run streamlit_app.py --server.headless true &
          STREAMLIT_PID=$!
          echo "Streamlit PID = $STREAMLIT_PID"
          # Wait 10 seconds
          sleep 10
          # Kill Streamlit
          kill $STREAMLIT_PID || true
          echo "Streamlit test complete"
